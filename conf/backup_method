#!/usr/bin/env bash
# Fail on error
set -Eeuo pipefail

source "__INSTALL_DIR__/script_helpers"

#=========================================================#
#                     GLOBAL VARS                         #
#=========================================================#

# Script name and path
THIS_SCRIPT=$(readlink -f "${BASH_SOURCE[0]}")
readonly THIS_SCRIPT

# yuno-archive script
readonly YUNO_ARCHIVE='__INSTALL_DIR__/yuno-archive.sh'

# Params sent by yunohost backup script
readonly BACKUP_TMP_DIR="$2"
readonly BACKUP_NAME="$3"
readonly LOCAL_REPO="$4"
readonly BACKUP_SIZE="$5"
readonly BACKUP_DESCRIPTION="$6"

# Export tmp dir root to use yunohost.backup (/tmp is often too small to create archive file)
# We use this in order to avoid multiple temp folder in yunohost.backup dir if app crashes before cleanup
export YARCH_TMPDIR="/home/yunohost.backup/tmp___APP__"
mkdir -p "$YARCH_TMPDIR"
# cleanup previous temp files (if app creshed)
rm -rf "${YARCH_TMPDIR:?}"/*

# Info file name
readonly INFO_FILE="${BACKUP_TMP_DIR}/info.json"

# Hook script
readonly HOOK_FILE="__INSTALL_DIR__/backup_hook"

#=========================================================#
#                    SCRIPT FUNCTIONS                     #
#=========================================================#

### FUNCTION BEGIN
# Get backup name, this name is deducted from config
# If we use an incremental backup we get the last incremental backup number and 
# determine if this number is over the max incremental number
# If over incremental number or not incremental, we use BACKUP_NAME
# OUTPUTS:
# 	Prints backup name to stdout
### FUNCTION END
create_backup_name() {
    if [[ $( get_conf is_incremental ) != "1" ]]; then
        echo "${BACKUP_NAME}"
        return 0
    fi

    local max_incremental_number
    max_incremental_number=$( get_conf max_incremental_number )
    local last_incremental_number
    last_incremental_number=$( get_conf last_incremental_number )
    local origin_incremental_name
    origin_incremental_name=$( get_conf origin_incremental_name )

    if [[ -z $origin_incremental_name || -z $last_incremental_number || -z $max_incremental_number ]]; then
        echo "${BACKUP_NAME}"
        return 0
    fi

    if [[ $last_incremental_number -ge $max_incremental_number ]]; then
        echo "${BACKUP_NAME}"
        return 0
    fi

    echo "$origin_incremental_name"
}

update_incremental_name() {
    local name="$1"

    if [[ $( get_conf is_incremental ) != "1" ]]; then
        return 0
    fi

    local last_incremental_number
    last_incremental_number=$( get_conf last_incremental_number )
    local new_incremental_number
    local max_incremental_number
    max_incremental_number=$( get_conf max_incremental_number )

    if [[ -z $last_incremental_number || $last_incremental_number -ge $max_incremental_number ]]; then
        new_incremental_number=0
    else
        new_incremental_number=$(( last_incremental_number + 1 ))
    fi

    set_conf origin_incremental_name "$name"
    set_conf last_incremental_number "$new_incremental_number"
}


do_need_mount() {
    true
}

do_mount() {
    true
}

do_backup() {
    local method
    method=$(get_conf_method)

    echo "---------- START BACKUP ${BACKUP_NAME} ${method} FROM ${THIS_SCRIPT} -----------" | tee -a "${YUNO-ARCHIVE_LOG_FILE}"

    set_conf last_run "$(date "+%Y-%m-%d %H:%M:%S")"
    set_conf state ongoing
    # Check size in tmp dir
    local available_space_in_temp
    available_space_in_temp=$(findmnt --target "$YARCH_TMPDIR" --output AVAIL --bytes --noheadings --first-only)
    if [[ $BACKUP_SIZE -gt $available_space_in_temp ]]; then
        echo "ERROR : Not enough space to create temp archive (space needed = $(hrb "${BACKUP_SIZE}") available space in temp ($YARCH_TMPDIR) = $(hrb "${available_space_in_temp}"))" >&2
        fail
    fi

    local verbose_option=""
    if [[ $( get_conf debug ) == "1" ]]; then
        verbose_option="--verbose"
    fi

    local incremental_option=""
    if [[ $( get_conf is_incremental ) == "1" ]]; then
        incremental_option="--incremental"
    fi

    local keep
    keep=$( get_conf keep )

    local repository
    repository=$( get_conf_repository )

    local name
    name=$( create_backup_name )

    case "$method" in
    local)
        $YUNO_ARCHIVE backup local \
            --log="${YUNO-ARCHIVE_LOG_FILE}" \
            --repository="${repository}" \
            --name="${name}" \
            --source="$BACKUP_TMP_DIR" \
            --compress="gzip" \
            --info="${INFO_FILE}" \
            --keep="${keep}" \
            --hook="${HOOK_FILE}" \
            "${verbose_option}" \
            "${incremental_option}" ||
            fail
        ;;
    # We won't fail with send_to_drive method because this method could be called directly in command line
    drive | send_to_drive)
        $YUNO_ARCHIVE backup drive \
            --log="${YUNO-ARCHIVE_LOG_FILE}" \
            --drive="${repository}" \
            --repository="ynh_archives" \
            --name="${name}" \
            --source="$BACKUP_TMP_DIR" \
            --compress="gzip" \
            --info="${INFO_FILE}" \
            --keep="${keep}" \
            --hook="${HOOK_FILE}" \
            "${verbose_option}" \
            "${incremental_option}" ||
            fail
        ;;
    # We won't fail with send_to_drive method because this method could be called directly in command line
    rclone | send_to_rclone)
        $YUNO_ARCHIVE backup rclone \
            --log="${YUNO-ARCHIVE_LOG_FILE}" \
            --repository="${repository}" \
            --path="ynh_archives" \
            --name="${name}" \
            --source="$BACKUP_TMP_DIR" \
            --compress="gzip" \
            --info="${INFO_FILE}" \
            --keep="${keep}" \
            --hook="${HOOK_FILE}" \
            "${verbose_option}" \
            "${incremental_option}" ||
            fail
        ;;
    *)
        echo "Unknown method '$method'" >&2
        fail
        ;;
    esac

    update_incremental_name "$name"

     # To make backup visible on yunohost Backup local menu, we add a symbolic link with only tar name
    if [[ $( get_conf ynh_repo ) == "1" ]]; then
        readonly ynh_archive_dir="/home/yunohost.backup/archives"

        local increment_suffix_name=""

        if [[ $( get_conf is_incremental ) == '1' ]]; then
            # last_incremental_number as been updated by update_incremental_name
            if [[ $( get_conf last_incremental_number ) == "0" ]]; then
                increment_suffix_name='.base'
            else
                increment_suffix_name=".inc${new_incremental_number}"
            fi
        fi

        local backup_name="${name}${increment_suffix_name}"
        ln -sfn "${ynh_archive_dir}/${backup_name}.tar.gz" "${ynh_archive_dir}/${backup_name}.tar"
    fi

    set_conf state successful
    echo "---------- END BACKUP ${BACKUP_NAME} ${method} FROM ${THIS_SCRIPT} -----------" | tee -a "${YUNO-ARCHIVE_LOG_FILE}"
    return 0
}

#=========================================================#
#                           MAIN                          #
#=========================================================#

case "$1" in
need_mount)
    do_need_mount
    ;;
mount)
    do_mount
    ;;
backup)
    do_backup
    ;;
*)
    echo "hook __APP__ called with unknown argument \`$1'" >&2
    exit 1
    ;;
esac

exit 0

